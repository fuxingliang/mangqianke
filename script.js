// 历史记录管理类
class DivinationHistory {
    constructor() {
        this.storageKey = 'liushen_divination_history';
        this.maxRecords = 100; // 最多保存100条记录
    }

    // 保存占卜记录
    saveRecord(result) {
        const record = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            date: new Date().toLocaleDateString('zh-CN'),
            time: new Date().toLocaleTimeString('zh-CN'),
            question: result.question || '未填写问题',
            lunarDate: `农历${result.month}月${result.day}日 ${result.hour}时`,
            liushen: result.liushen,
            fortune: result.result.fortune,
            text: result.result.text,
            meaning: result.result.meaning,
            steps: result.steps
        };

        const records = this.getRecords();
        records.unshift(record); // 新记录添加到开头

        // 限制记录数量
        if (records.length > this.maxRecords) {
            records.splice(this.maxRecords);
        }

        localStorage.setItem(this.storageKey, JSON.stringify(records));
        return record;
    }

    // 获取所有记录
    getRecords() {
        try {
            const records = localStorage.getItem(this.storageKey);
            return records ? JSON.parse(records) : [];
        } catch (error) {
            console.error('读取历史记录失败:', error);
            return [];
        }
    }

    // 删除记录
    deleteRecord(id) {
        const records = this.getRecords();
        const filteredRecords = records.filter(record => record.id !== id);
        localStorage.setItem(this.storageKey, JSON.stringify(filteredRecords));
    }

    // 清空所有记录
    clearAllRecords() {
        localStorage.removeItem(this.storageKey);
    }

    // 搜索记录
    searchRecords(keyword) {
        const records = this.getRecords();
        if (!keyword) return records;

        const lowerKeyword = keyword.toLowerCase();
        return records.filter(record => 
            record.question.toLowerCase().includes(lowerKeyword) ||
            record.liushen.includes(keyword) ||
            record.text.includes(keyword) ||
            record.meaning.toLowerCase().includes(lowerKeyword)
        );
    }
}

// 万年历类
class Calendar {
    constructor() {
        this.currentDate = new Date();
        this.selectedDate = null;
        this.monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', 
                          '七月', '八月', '九月', '十月', '十一月', '十二月'];
        this.dayNames = ['日', '一', '二', '三', '四', '五', '六'];
        
        // 农历月份名称
        this.lunarMonths = ['正月', '二月', '三月', '四月', '五月', '六月',
                           '七月', '八月', '九月', '十月', '十一月', '十二月'];
        
        // 农历日期名称
        this.lunarDays = ['', '初一', '初二', '初三', '初四', '初五', '初六', '初七', '初八', '初九', '初十',
                         '十一', '十二', '十三', '十四', '十五', '十六', '十七', '十八', '十九', '二十',
                         '廿一', '廿二', '廿三', '廿四', '廿五', '廿六', '廿七', '廿八', '廿九', '三十'];
        
        this.initCalendar();
    }
    
    initCalendar() {
        this.bindCalendarEvents();
        this.renderCalendar();
    }
    
    bindCalendarEvents() {
        // 月份切换事件
        document.getElementById('prevMonth').addEventListener('click', () => {
            this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            this.renderCalendar();
        });
        
        document.getElementById('nextMonth').addEventListener('click', () => {
            this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            this.renderCalendar();
        });
        
        // 年份切换事件
        document.getElementById('prevYear').addEventListener('click', () => {
            this.currentDate.setFullYear(this.currentDate.getFullYear() - 1);
            this.renderCalendar();
        });
        
        document.getElementById('nextYear').addEventListener('click', () => {
            this.currentDate.setFullYear(this.currentDate.getFullYear() + 1);
            this.renderCalendar();
        });
    }
    
    renderCalendar() {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        
        // 更新年份和月份显示
        document.getElementById('currentYear').textContent = `${year}年`;
        document.getElementById('currentMonth').textContent = this.monthNames[month];
        
        // 生成日历网格
        const calendarGrid = document.getElementById('calendarGrid');
        calendarGrid.innerHTML = '';
        
        // 添加星期标题
        this.dayNames.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.textContent = day;
            calendarGrid.appendChild(header);
        });
        
        // 获取当月第一天和最后一天
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        // 生成42个日期格子（6周）
        for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            // 判断是否为当月日期
            if (date.getMonth() !== month) {
                dayElement.classList.add('other-month');
            }
            
            // 判断是否为今天
            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                dayElement.classList.add('today');
            }
            
            // 获取农历日期
            const lunarDate = this.solarToLunar(date);
            
            // 设置日期内容
            dayElement.innerHTML = `
                <div class="solar-date">${date.getDate()}</div>
                <div class="lunar-date">${lunarDate.monthName}${lunarDate.dayName}</div>
            `;
            
            // 添加点击事件
            dayElement.addEventListener('click', () => {
                this.selectDate(date, lunarDate);
            });
            
            calendarGrid.appendChild(dayElement);
        }
    }
    
    selectDate(date, lunarDate) {
        // 移除之前的选中状态
        document.querySelectorAll('.calendar-day.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // 添加选中状态
        event.target.closest('.calendar-day').classList.add('selected');
        
        this.selectedDate = { solar: date, lunar: lunarDate };
        
        // 更新选中日期信息
        this.updateSelectedDateInfo();
        
        // 自动填充占卜表单
        this.fillDivinationForm();
    }
    
    updateSelectedDateInfo() {
        const info = document.getElementById('selectedDateInfo');
        if (this.selectedDate) {
            const { solar, lunar } = this.selectedDate;
            const ganzhi = this.calculateGanZhi(solar);
            info.innerHTML = `
                <p class="date-detail">公历：${solar.getFullYear()}年${solar.getMonth() + 1}月${solar.getDate()}日</p>
                <p class="lunar-detail">农历：${lunar.year}年${lunar.monthName}${lunar.dayName}</p>
                <p class="ganzhi-detail">干支：${ganzhi.year}年 ${ganzhi.month}月 ${ganzhi.day}日</p>
            `;
        } else {
            info.innerHTML = '<p>请点击日期选择</p>';
        }
    }
    
    fillDivinationForm() {
        if (this.selectedDate) {
            const { lunar } = this.selectedDate;
            
            // 填充农历月份
            document.getElementById('month').value = lunar.month;
            
            // 填充农历日期
            document.getElementById('day').value = lunar.day;
            
            // 根据当前时间设置时辰（如果还没有选择的话）
            const hourSelect = document.getElementById('hour');
            if (!hourSelect.value) {
                const now = new Date();
                const hour = now.getHours();
                let defaultHour = '';
                
                if (hour >= 23 || hour < 1) defaultHour = '子';
                else if (hour >= 1 && hour < 3) defaultHour = '丑';
                else if (hour >= 3 && hour < 5) defaultHour = '寅';
                else if (hour >= 5 && hour < 7) defaultHour = '卯';
                else if (hour >= 7 && hour < 9) defaultHour = '辰';
                else if (hour >= 9 && hour < 11) defaultHour = '巳';
                else if (hour >= 11 && hour < 13) defaultHour = '午';
                else if (hour >= 13 && hour < 15) defaultHour = '未';
                else if (hour >= 15 && hour < 17) defaultHour = '申';
                else if (hour >= 17 && hour < 19) defaultHour = '酉';
                else if (hour >= 19 && hour < 21) defaultHour = '戌';
                else if (hour >= 21 && hour < 23) defaultHour = '亥';
                
                hourSelect.value = defaultHour;
            }
        }
    }
    
    // 农历数据表 (1900-2100年)
    getLunarData() {
        // 农历数据：每年12个月的天数信息，闰月信息
        // 数据格式：0x表示16进制，每4位表示一个月的天数(0=29天,1=30天)
        // 最后4位表示闰月月份(0表示无闰月)
        return {
            // 1900-1999年农历数据
            1900: 0x04bd8, 1901: 0x04ae0, 1902: 0x0a570, 1903: 0x054d5, 1904: 0x0d260,
            1905: 0x0d950, 1906: 0x16554, 1907: 0x056a0, 1908: 0x09ad0, 1909: 0x055d2,
            1910: 0x04ae0, 1911: 0x0a5b6, 1912: 0x0a4d0, 1913: 0x0d250, 1914: 0x1d255,
            1915: 0x0b540, 1916: 0x0d6a0, 1917: 0x0ada2, 1918: 0x095b0, 1919: 0x14977,
            1920: 0x04970, 1921: 0x0a4b0, 1922: 0x0b4b5, 1923: 0x06a50, 1924: 0x06d40,
            1925: 0x1ab54, 1926: 0x02b60, 1927: 0x09570, 1928: 0x052f2, 1929: 0x04970,
            1930: 0x06566, 1931: 0x0d4a0, 1932: 0x0ea50, 1933: 0x06e95, 1934: 0x05ad0,
            1935: 0x02b60, 1936: 0x186e3, 1937: 0x092e0, 1938: 0x1c8d7, 1939: 0x0c950,
            1940: 0x0d4a0, 1941: 0x1d8a6, 1942: 0x0b550, 1943: 0x056a0, 1944: 0x1a5b4,
            1945: 0x025d0, 1946: 0x092d0, 1947: 0x0d2b2, 1948: 0x0a950, 1949: 0x0b557,
            1950: 0x06ca0, 1951: 0x0b550, 1952: 0x15355, 1953: 0x04da0, 1954: 0x0a5b0,
            1955: 0x14573, 1956: 0x052b0, 1957: 0x0a9a8, 1958: 0x0e950, 1959: 0x06aa0,
            1960: 0x0aea6, 1961: 0x0ab50, 1962: 0x04b60, 1963: 0x0aae4, 1964: 0x0a570,
            1965: 0x05260, 1966: 0x0f263, 1967: 0x0d950, 1968: 0x05b57, 1969: 0x056a0,
            1970: 0x096d0, 1971: 0x04dd5, 1972: 0x04ad0, 1973: 0x0a4d0, 1974: 0x0d4d4,
            1975: 0x0d250, 1976: 0x0d558, 1977: 0x0b540, 1978: 0x0b6a0, 1979: 0x195a6,
            1980: 0x095b0, 1981: 0x049b0, 1982: 0x0a974, 1983: 0x0a4b0, 1984: 0x0b27a,
            1985: 0x06a50, 1986: 0x06d40, 1987: 0x0af46, 1988: 0x0ab60, 1989: 0x09570,
            1990: 0x04af5, 1991: 0x04970, 1992: 0x064b0, 1993: 0x074a3, 1994: 0x0ea50,
            1995: 0x06b58, 1996: 0x055c0, 1997: 0x0ab60, 1998: 0x096d5, 1999: 0x092e0,
            // 2000-2099年农历数据
            2000: 0x0c960, 2001: 0x0d954, 2002: 0x0d4a0, 2003: 0x0da50, 2004: 0x07552,
            2005: 0x056a0, 2006: 0x0abb7, 2007: 0x025d0, 2008: 0x092d0, 2009: 0x0cab5,
            2010: 0x0a950, 2011: 0x0b4a0, 2012: 0x0baa4, 2013: 0x0ad50, 2014: 0x055d9,
            2015: 0x04ba0, 2016: 0x0a5b0, 2017: 0x15176, 2018: 0x052b0, 2019: 0x0a930,
            2020: 0x07954, 2021: 0x06aa0, 2022: 0x0ad50, 2023: 0x05b52, 2024: 0x04b60,
            2025: 0x0a6e6, 2026: 0x0a4e0, 2027: 0x0d260, 2028: 0x0ea65, 2029: 0x0d530,
            2030: 0x05aa0, 2031: 0x076a3, 2032: 0x096d0, 2033: 0x04afb, 2034: 0x04ad0,
            2035: 0x0a4d0, 2036: 0x1d0b6, 2037: 0x0d250, 2038: 0x0d520, 2039: 0x0dd45,
            2040: 0x0b5a0, 2041: 0x056d0, 2042: 0x055b2, 2043: 0x049b0, 2044: 0x0a577,
            2045: 0x0a4b0, 2046: 0x0aa50, 2047: 0x1b255, 2048: 0x06d20, 2049: 0x0ada0,
            2050: 0x14b63, 2051: 0x09370, 2052: 0x049f8, 2053: 0x04970, 2054: 0x064b0,
            2055: 0x168a6, 2056: 0x0ea50, 2057: 0x06b20, 2058: 0x1a6c4, 2059: 0x0aae0,
            2060: 0x0a2e0, 2061: 0x0d2e3, 2062: 0x0c960, 2063: 0x0d557, 2064: 0x0d4a0,
            2065: 0x0da50, 2066: 0x05d55, 2067: 0x056a0, 2068: 0x0a6d0, 2069: 0x055d4,
            2070: 0x052d0, 2071: 0x0a9b8, 2072: 0x0a950, 2073: 0x0b4a0, 2074: 0x0b6a6,
            2075: 0x0ad50, 2076: 0x055a0, 2077: 0x0aba4, 2078: 0x0a5b0, 2079: 0x052b0,
            2080: 0x0b273, 2081: 0x06930, 2082: 0x07337, 2083: 0x06aa0, 2084: 0x0ad50,
            2085: 0x14b55, 2086: 0x04b60, 2087: 0x0a570, 2088: 0x054e4, 2089: 0x0d160,
            2090: 0x0e968, 2091: 0x0d520, 2092: 0x0daa0, 2093: 0x16aa6, 2094: 0x056d0,
            2095: 0x04ae0, 2096: 0x0a9d4, 2097: 0x0a2d0, 2098: 0x0d150, 2099: 0x0f252,
            2100: 0x0d520
        };
    }

    // 公历转农历算法
    solarToLunar(solarDate) {
        const year = solarDate.getFullYear();
        const month = solarDate.getMonth() + 1;
        const day = solarDate.getDate();
        
        // 检查年份范围
        if (year < 1900 || year > 2100) {
            // 超出范围时使用简化算法
            return this.simpleSolarToLunar(solarDate);
        }
        
        const lunarData = this.getLunarData();
        
        // 1900年1月31日为农历1900年正月初一
        const baseDate = new Date(1900, 0, 31);
        const targetDate = new Date(year, month - 1, day);
        
        // 计算目标日期与基准日期的天数差
        let totalDays = Math.floor((targetDate - baseDate) / (24 * 60 * 60 * 1000));
        
        // 计算农历年月日
        let lunarYear = 1900;
        let lunarMonth = 1;
        let lunarDay = 1;
        let isLeapMonth = false;
        
        // 找到对应的农历年份
        while (totalDays > 0) {
            const yearDays = this.getLunarYearDays(lunarYear, lunarData);
            if (totalDays >= yearDays) {
                totalDays -= yearDays;
                lunarYear++;
            } else {
                break;
            }
        }
        
        // 找到对应的农历月份
        const yearData = lunarData[lunarYear];
        const leapMonth = yearData & 0xf; // 闰月
        lunarMonth = 1;
        
        for (let i = 1; i <= 12; i++) {
            let monthDays = (yearData & (0x10000 >> i)) ? 30 : 29;
            
            if (totalDays < monthDays) {
                lunarMonth = i;
                break;
            }
            
            totalDays -= monthDays;
            
            // 处理闰月
            if (leapMonth > 0 && i === leapMonth) {
                monthDays = (yearData & 0x10000) ? 30 : 29; // 闰月天数
                if (totalDays < monthDays) {
                    lunarMonth = i;
                    isLeapMonth = true;
                    break;
                }
                totalDays -= monthDays;
            }
        }
        
        lunarDay = totalDays + 1;
        
        return {
            year: lunarYear,
            month: lunarMonth,
            day: lunarDay,
            isLeapMonth: isLeapMonth,
            monthName: (isLeapMonth ? '闰' : '') + this.lunarMonths[lunarMonth - 1],
            dayName: this.lunarDays[lunarDay]
        };
    }
    
    // 获取农历年总天数
    getLunarYearDays(year, lunarData) {
        const yearData = lunarData[year];
        if (!yearData) return 354; // 默认值
        
        let days = 0;
        // 计算12个月的天数
        for (let i = 0x8000; i > 0x8; i >>= 1) {
            days += (yearData & i) ? 30 : 29;
        }
        
        // 加上闰月天数
        const leapMonth = yearData & 0xf;
        if (leapMonth > 0) {
            days += (yearData & 0x10000) ? 30 : 29;
        }
        
        return days;
    }
    
    // 获取公历月份天数
    getSolarMonthDays(year, month) {
        const monthDays = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        if (month === 2 && this.isLeapYear(year)) {
            return 29;
        }
        return monthDays[month - 1];
    }
    
    // 判断是否为闰年
    isLeapYear(year) {
        return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
    }
    
    // 简化算法（用于超出数据范围的年份）
    simpleSolarToLunar(solarDate) {
        const year = solarDate.getFullYear();
        const month = solarDate.getMonth() + 1;
        const day = solarDate.getDate();
        
        // 使用近似算法
        let lunarYear = year;
        let lunarMonth = month - 1;
        let lunarDay = day - 10;
        
        if (lunarMonth <= 0) {
            lunarMonth += 12;
            lunarYear -= 1;
        }
        
        if (lunarDay <= 0) {
            lunarDay += 29;
            lunarMonth -= 1;
            if (lunarMonth <= 0) {
                lunarMonth += 12;
                lunarYear -= 1;
            }
        }
        
        if (lunarDay > 30) {
            lunarDay -= 29;
            lunarMonth += 1;
            if (lunarMonth > 12) {
                lunarMonth -= 12;
                lunarYear += 1;
            }
        }
        
        return {
            year: lunarYear,
            month: lunarMonth,
            day: lunarDay,
            isLeapMonth: false,
            monthName: this.lunarMonths[lunarMonth - 1],
            dayName: this.lunarDays[lunarDay]
        };
    }

    // 计算干支纪年、纪月、纪日
    // 获取二十四节气数据
    getSolarTerms() {
        // 二十四节气名称
        const solarTermNames = [
            '小寒', '大寒', '立春', '雨水', '惊蛰', '春分',
            '清明', '谷雨', '立夏', '小满', '芒种', '夏至',
            '小暑', '大暑', '立秋', '处暑', '白露', '秋分',
            '寒露', '霜降', '立冬', '小雪', '大雪', '冬至'
        ];
        
        // 节气对应的月份地支（立春开始为寅月）
        const monthZhi = ['寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥', '子', '丑'];
        
        return { solarTermNames, monthZhi };
    }

    // 计算节气日期（简化算法，基于平均值）
    // 计算节气日期（使用更精确的算法）
    // 获取精确节气数据（基于天文台观测数据）
    getPreciseSolarTermsData() {
        // 完整的1900-2100年精确节气数据表
        // 每行格式：[小寒, 大寒, 立春, 雨水, 惊蛰, 春分, 清明, 谷雨, 立夏, 小满, 芒种, 夏至, 小暑, 大暑, 立秋, 处暑, 白露, 秋分, 寒露, 霜降, 立冬, 小雪, 大雪, 冬至]
        const solarTermsTable = {
            1900: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1901: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1902: [6,21,5,19,6,21,6,21,6,22,7,22,8,24,8,24,8,24,9,24,8,23,8,23],
            1903: [6,21,5,20,7,22,6,21,7,22,7,22,8,24,9,24,9,24,9,24,8,23,8,23],
            1904: [7,21,5,20,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1905: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1906: [6,21,5,19,6,21,6,21,6,22,6,22,8,24,8,24,8,24,9,24,8,23,8,23],
            1907: [6,21,5,20,7,22,6,21,7,22,7,22,8,24,9,24,9,24,9,24,8,23,8,23],
            1908: [7,21,5,20,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1909: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1910: [6,21,5,19,6,21,6,21,6,22,6,22,8,24,8,24,8,24,9,24,8,23,8,23],
            1911: [6,21,5,20,7,22,6,21,7,22,7,22,8,24,9,24,9,24,9,24,8,23,8,23],
            1912: [7,21,5,20,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1913: [6,20,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1914: [6,21,4,19,6,21,5,21,6,22,6,22,8,24,8,24,8,24,9,24,8,23,8,23],
            1915: [6,21,5,20,6,22,6,21,6,22,7,22,8,24,8,24,9,24,9,24,8,23,8,23],
            1916: [6,21,5,20,6,21,5,20,6,21,6,22,7,23,8,23,8,23,8,24,8,22,7,22],
            1917: [6,20,4,19,6,21,5,21,6,21,6,22,8,23,8,24,8,23,9,24,8,23,7,22],
            1918: [6,21,4,19,6,21,5,21,6,22,6,22,8,24,8,24,8,24,9,24,8,23,8,22],
            1919: [6,21,5,20,6,22,6,21,6,22,7,22,8,24,8,24,9,24,9,24,8,23,8,23],
            1920: [6,21,5,20,6,21,5,20,6,21,6,22,7,23,8,23,8,23,8,24,8,22,7,22],
            1921: [6,20,4,19,6,21,5,20,6,21,6,22,8,23,8,24,8,23,9,24,8,23,7,22],
            1922: [6,21,4,19,6,21,5,21,6,22,6,22,8,24,8,24,8,24,9,24,8,23,8,22],
            1923: [6,21,5,19,6,21,6,21,6,22,7,22,8,24,8,24,9,24,9,24,8,23,8,23],
            1924: [6,21,5,20,6,21,5,20,6,21,6,22,7,23,8,23,8,23,8,24,8,22,7,22],
            1925: [6,20,4,19,6,21,5,20,6,21,6,22,8,23,8,24,8,23,9,24,8,23,7,22],
            1926: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1927: [6,21,5,19,6,21,6,21,6,22,7,22,8,24,8,24,8,24,9,24,8,23,8,23],
            1928: [6,21,5,20,6,21,5,20,6,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1929: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1930: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1931: [6,21,5,19,6,21,6,21,6,22,7,22,8,24,8,24,8,24,9,24,8,23,8,23],
            1932: [6,21,5,20,6,21,5,20,6,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1933: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1934: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1935: [6,21,5,19,6,21,6,21,6,22,6,22,8,24,8,24,8,24,9,24,8,23,8,23],
            1936: [6,21,5,20,6,21,5,20,6,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1937: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1938: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1939: [6,21,5,19,6,21,6,21,6,22,6,22,8,24,8,24,8,24,9,24,8,23,8,23],
            1940: [6,21,5,20,6,21,5,20,6,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1941: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1942: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1943: [6,21,5,19,6,21,6,21,6,22,6,22,8,24,8,24,8,24,9,24,8,23,8,23],
            1944: [6,21,5,20,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1945: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,8,24,8,22,7,22],
            1946: [6,20,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,23,9,24,8,23,8,22],
            1947: [6,21,4,19,6,21,5,21,6,22,6,22,8,24,8,24,8,24,9,24,8,23,8,23],
            1948: [6,21,5,20,5,21,5,20,5,21,6,21,7,23,7,23,8,23,8,23,7,22,7,22],
            1949: [5,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,8,24,8,22,7,22],
            1950: [6,20,4,19,6,21,5,20,6,21,6,22,8,23,8,24,8,23,9,24,8,23,8,22],
            1951: [6,21,4,19,6,21,5,21,6,22,6,22,8,24,8,24,8,24,9,24,8,23,8,23],
            1952: [6,21,5,20,5,21,5,20,5,21,6,21,7,23,7,23,8,23,8,23,7,22,7,22],
            1953: [5,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,8,24,8,22,7,22],
            1954: [6,20,4,19,6,21,5,20,6,21,6,22,8,23,8,24,8,23,9,24,8,23,7,22],
            1955: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1956: [6,21,5,20,5,20,5,20,5,21,6,21,7,23,7,23,8,23,8,23,7,22,7,22],
            1957: [5,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,8,24,8,22,7,22],
            1958: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1959: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1960: [6,21,5,19,5,20,5,20,5,21,6,21,7,23,7,23,7,23,8,23,7,22,7,22],
            1961: [5,20,4,19,6,21,5,20,6,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1962: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1963: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1964: [6,21,5,19,5,20,5,20,5,21,6,21,7,23,7,23,7,23,8,23,7,22,7,22],
            1965: [5,20,4,19,6,21,5,20,6,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1966: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1967: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1968: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            1969: [5,20,4,19,6,21,5,20,6,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1970: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1971: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1972: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            1973: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1974: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1975: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1976: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            1977: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1978: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1979: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1980: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            1981: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1982: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1983: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1984: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            1985: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1986: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1987: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1988: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            1989: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1990: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1991: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1992: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            1993: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1994: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1995: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            1996: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            1997: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            1998: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            1999: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            2000: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2001: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2002: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            2003: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            2004: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2005: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2006: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            2007: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            2008: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2009: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2010: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            2011: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            2012: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2013: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2014: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            2015: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            2016: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2017: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2018: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            2019: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            2020: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2021: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2022: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,7,22],
            2023: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,22],
            2024: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2025: [5,20,3,18,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,7,22],
            2026: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2027: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2028: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2029: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2030: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2031: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2032: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2033: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2034: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2035: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2036: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2037: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2038: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2039: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2040: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2041: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2042: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2043: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2044: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2045: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2046: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2047: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2048: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2049: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2050: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2051: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2052: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2053: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2054: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2055: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2056: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2057: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2058: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2059: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2060: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2061: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2062: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2063: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2064: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2065: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2066: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2067: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2068: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2069: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2070: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2071: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2072: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2073: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2074: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2075: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2076: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2077: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2078: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2079: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2080: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2081: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2082: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2083: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2084: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2085: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2086: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2087: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2088: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2089: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2090: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2091: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2092: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2093: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2094: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2095: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2096: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22],
            2097: [5,20,4,19,6,21,5,20,5,21,6,21,7,23,8,23,8,23,8,23,7,22,7,22],
            2098: [6,20,4,19,6,21,5,20,6,21,6,22,7,23,8,23,8,23,9,24,8,23,8,22],
            2099: [6,21,4,19,6,21,5,21,6,22,6,22,8,23,8,24,8,24,9,24,8,23,8,23],
            2100: [6,21,5,19,5,20,5,20,5,21,5,21,7,23,7,23,7,23,8,23,7,22,7,22]
        };
        
        return solarTermsTable;
    }

    calculateSolarTerm(year, termIndex) {
        // 获取精确节气数据
        const solarTermsData = this.getPreciseSolarTermsData();
        
        // 如果有该年份的精确数据，直接使用
        if (solarTermsData[year]) {
            const termDay = solarTermsData[year][termIndex];
            const month = Math.floor(termIndex / 2) + 1;
            return new Date(year, month - 1, termDay);
        }
        
        // 如果没有精确数据，使用传统算法作为后备
        return this.calculateSolarTermLegacy(year, termIndex);
    }

    calculateSolarTermByInterpolation(year, termIndex) {
        const preciseData = this.getPreciseSolarTermsData();
        
        // 限制年份范围
        if (year < 1900) year = 1900;
        if (year > 2100) year = 2100;
        
        // 找到相邻的关键年份
        const lowerYear = Math.floor(year / 10) * 10;
        const upperYear = lowerYear + 10;
        
        // 如果正好是关键年份，直接使用精确数据
        if (preciseData[year]) {
            const dayOfYear = preciseData[year][termIndex];
            return this.dayOfYearToDate(year, dayOfYear);
        }
        
        // 线性插值计算
        const lowerData = preciseData[lowerYear];
        const upperData = preciseData[upperYear];
        
        if (!lowerData || !upperData) {
            // 如果没有数据，使用传统算法作为后备
            return this.calculateSolarTermLegacy(year, termIndex);
        }
        
        const ratio = (year - lowerYear) / 10;
        const lowerDay = lowerData[termIndex];
        const upperDay = upperData[termIndex];
        
        // 插值计算天数
        const interpolatedDay = Math.round(lowerDay + (upperDay - lowerDay) * ratio);
        
        return this.dayOfYearToDate(year, interpolatedDay);
    }

    // 将年内天数转换为具体日期
    dayOfYearToDate(year, dayOfYear) {
        const date = new Date(year, 0, 1);
        date.setDate(dayOfYear);
        return date;
    }

    // 传统算法作为后备
    calculateSolarTermLegacy(year, termIndex) {
        const baseDays = [
            6, 20, 4, 19, 6, 21, 5, 20, 6, 21, 6, 22,
            7, 23, 8, 23, 8, 23, 8, 24, 8, 23, 7, 22
        ];
        
        const yearChange = [
            0, 21208, 43467, 63836, 85337, 107014,
            128867, 150921, 173149, 195551, 218072, 240693,
            263343, 285989, 308563, 331033, 353350, 375494,
            397447, 419210, 440795, 462224, 483532, 504758
        ];
        
        const baseYear = 1900;
        const yearDiff = year - baseYear;
        
        let day = baseDays[termIndex];
        let minutes = yearChange[termIndex] * yearDiff / 10000;
        day += Math.floor(minutes / (24 * 60));
        
        let month = Math.floor(termIndex / 2) + 1;
        if (termIndex % 2 === 0) {
            if (termIndex === 0) month = 1;
            else if (termIndex === 2) month = 2;
            else month = Math.floor(termIndex / 2) + 1;
        } else {
            month = Math.floor(termIndex / 2) + 1;
        }
        
        return new Date(year, month - 1, day);
    }

    // 获取指定日期所在的农历月份地支
    getLunarMonthZhi(date) {
        const year = date.getFullYear();
        const { monthZhi } = this.getSolarTerms();
        
        // 节气对应的月份地支（从立春开始）
        // 立春-惊蛰：寅月，惊蛰-清明：卯月，清明-立夏：辰月，立夏-芒种：巳月
        // 芒种-小暑：午月，小暑-立秋：未月，立秋-白露：申月，白露-寒露：酉月
        // 寒露-立冬：戌月，立冬-大雪：亥月，大雪-小寒：子月，小寒-立春：丑月
        const monthZhiOrder = ['寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥', '子', '丑'];
        
        // 节气索引：立春=2, 惊蛰=4, 清明=6, 立夏=8, 芒种=10, 小暑=12, 立秋=14, 白露=16, 寒露=18, 立冬=20, 大雪=22, 小寒=0
        const solarTermIndexes = [2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 0];
        
        // 检查每个月份的节气范围
        for (let i = 0; i < 12; i++) {
            const currentTermIndex = solarTermIndexes[i];
            const nextTermIndex = solarTermIndexes[(i + 1) % 12];
            
            let currentTerm, nextTerm;
            
            if (currentTermIndex === 0) {
                // 小寒在下一年
                currentTerm = this.calculateSolarTerm(year + 1, 0);
            } else {
                currentTerm = this.calculateSolarTerm(year, currentTermIndex);
            }
            
            if (nextTermIndex === 0) {
                // 下一个节气是小寒（下一年）
                nextTerm = this.calculateSolarTerm(year + 1, 0);
            } else if (nextTermIndex === 2 && i === 11) {
                // 从丑月到寅月，跨年的立春
                nextTerm = this.calculateSolarTerm(year + 1, 2);
            } else {
                nextTerm = this.calculateSolarTerm(year, nextTermIndex);
            }
            
            // 特殊处理：子月和丑月跨年的情况
            if (i === 10) { // 子月（大雪到小寒）
                const daxue = this.calculateSolarTerm(year, 22); // 大雪
                const xiaihan = this.calculateSolarTerm(year + 1, 0); // 下一年小寒
                if (date >= daxue && date < xiaihan) {
                    return '子';
                }
            } else if (i === 11) { // 丑月（小寒到立春）
                const xiaihan = this.calculateSolarTerm(year, 0); // 小寒
                const lichun = this.calculateSolarTerm(year, 2); // 立春
                if (date >= xiaihan && date < lichun) {
                    return '丑';
                }
                // 也要检查跨年的情况
                const nextXiaihan = this.calculateSolarTerm(year + 1, 0); // 下一年小寒
                const nextLichun = this.calculateSolarTerm(year + 1, 2); // 下一年立春
                if (date >= nextXiaihan && date < nextLichun) {
                    return '丑';
                }
            } else {
                // 正常情况
                if (date >= currentTerm && date < nextTerm) {
                    return monthZhiOrder[i];
                }
            }
        }
        
        return '寅'; // 默认返回寅月
    }

    calculateGanZhi(date) {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();

        // 天干地支数组
        const tiangan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
        const dizhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];

        // 计算年干支（以立春为界）
        let ganzhiYear = year;
        const lichun = this.calculateSolarTerm(year, 2); // 立春节气
        
        // 如果当前日期在立春之前，属于上一年的干支年
        if (date < lichun) {
            ganzhiYear = year - 1;
        }
        
        // 年干支计算（以甲子年为基准，公元4年为甲子年）
        const yearGanIndex = (ganzhiYear - 4) % 10;
        const yearZhiIndex = (ganzhiYear - 4) % 12;
        const yearGanZhi = tiangan[yearGanIndex < 0 ? yearGanIndex + 10 : yearGanIndex] + 
                          dizhi[yearZhiIndex < 0 ? yearZhiIndex + 12 : yearZhiIndex];

        // 月干支计算（基于节气）
        const monthZhiName = this.getLunarMonthZhi(date);
        const monthZhiIndex = dizhi.indexOf(monthZhiName);
        
        // 月干计算：甲己之年丙作首，乙庚之岁戊为头，丙辛必定寻庚起，丁壬壬位顺行流，戊癸何方发，甲寅好追求
        // 修正：应该是从寅月开始计算
        const monthGanStart = [2, 4, 6, 8, 0]; // 对应甲、乙、丙、丁、戊年的寅月天干（丙、戊、庚、壬、甲）
        const yearGanMod = (yearGanIndex < 0 ? yearGanIndex + 10 : yearGanIndex) % 5;
        
        // 寅月在地支中的索引是2，计算相对于寅月的偏移
        const yinIndex = 2; // 寅在地支中的索引
        let monthOffset = monthZhiIndex - yinIndex;
        if (monthOffset < 0) monthOffset += 12;
        
        const monthGanIndex = (monthGanStart[yearGanMod] + monthOffset) % 10;
        const monthGanZhi = tiangan[monthGanIndex] + monthZhiName;

        // 日干支计算（使用准确的基准日期）
        // 使用2000年1月1日为基准，该日为戊午日
        const baseDate = new Date(2000, 0, 1); // 2000年1月1日戊午日
        const currentDate = new Date(year, month - 1, day);
        const daysDiff = Math.floor((currentDate - baseDate) / (1000 * 60 * 60 * 24));
        
        // 2000年1月1日是戊午日，戊=4，午=6
        const baseGanIndex = 4; // 戊
        const baseZhiIndex = 6; // 午
        
        // 计算当前日期的干支
        let dayGanIndex = (baseGanIndex + daysDiff) % 10;
        let dayZhiIndex = (baseZhiIndex + daysDiff) % 12;
        
        // 处理负数情况
        if (dayGanIndex < 0) dayGanIndex += 10;
        if (dayZhiIndex < 0) dayZhiIndex += 12;
        
        const dayGanZhi = tiangan[dayGanIndex] + dizhi[dayZhiIndex];

        return {
            year: yearGanZhi,
            month: monthGanZhi,
            day: dayGanZhi
        };
    }
}

// 六神占卜应用
class LiushenDivination {
    constructor() {
        // 六神顺序
        this.liushenOrder = ['大安', '留连', '速喜', '赤口', '小吉', '空亡'];
        
        // 地支顺序
        this.dizhiOrder = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        
        // 六神与地支的对应关系（用于显示）
        this.liushenToZhi = {
            '大安': '寅', '留连': '巳', '速喜': '午', 
            '赤口': '未', '小吉': '子', '空亡': '丑'
        };
        
        // 历史记录管理
        this.history = new DivinationHistory();
        
        // 当前占卜结果（用于保存）
        this.currentResult = null;
        
        // 六神断语和解释
        this.liushenResults = {
            '大安': {
                fortune: '吉',
                text: '大安事事昌，筹谋在东方，失物去不远，宅舍保安康，行人身未动，病者主无妨，将军归田野，仔细欲推详。',
                meaning: '大安为吉神，主平安顺利。凡事宜静不宜动，求谋可成，但需耐心等待。失物在附近，病人无大碍，出行平安。工作会非常顺利，心想事成。'
            },
            '留连': {
                fortune: '凶',
                text: '留连事难成，求谋日未明，官事只宜缓，去者未回程，失物南方见，急讨方称心，更须防口舌，人口且平平。',
                meaning: '留连为凶神，主拖延阻滞。做事容易遇到阻碍，进展缓慢。需要耐心等待，不宜急躁。注意防范口舌是非，凡事宜缓不宜急。'
            },
            '速喜': {
                fortune: '吉',
                text: '速喜喜来临，求财南方行，失物申午未，逢人路上寻，官事有福德，病者无祸侵，田家六畜吉，行人有信音。',
                meaning: '速喜为吉神，主快速成功。求谋易成，财运亨通。失物可寻回，病人康复快。有贵人相助，好消息即将到来，事业发展迅速。'
            },
            '赤口': {
                fortune: '凶',
                text: '赤口主口舌，官非切要防，失物急去寻，行人有惊慌，鸡犬多作怪，病者出西方，更须防咀咒，恐怕染瘟殃。',
                meaning: '赤口为凶神，主口舌是非。容易发生争执和官司，需要谨言慎行。病人需要特别注意，可能有意外发生。工作中要防小人。'
            },
            '小吉': {
                fortune: '吉',
                text: '小吉最吉昌，遇事好商量，阳人来报信，失物在坤方，行人即便至，交关甚是强，凡事皆和合，病者事无妨。',
                meaning: '小吉为吉神，主大吉，有收获。适合商谈合作，会有贵人相助。病人病有救，工作顺利。'
            },
            '空亡': {
                fortune: '凶',
                text: '空亡事不祥，阴人多乖张，求财无利益，行人有灾殃，失物寻不见，官事有刑伤，病人逢暗鬼，析解保安康。',
                meaning: '空亡为凶神，主空虚无获。做事容易落空，求财无利。需要特别小心，避免投资和重大决定。病人虚病需化解，工作可能有变动。'
            }
        };
        
        this.initializeApp();
    }
    
    // 初始化应用
    initializeApp() {
        this.bindEvents();
        this.setDefaultTime();
    }
    
    // 绑定事件
    bindEvents() {
        const divineBtn = document.getElementById('divineBtn');
        const newDivineBtn = document.getElementById('newDivineBtn');
        const saveRecordBtn = document.getElementById('saveRecordBtn');
        const historyBtn = document.getElementById('historyBtn');
        const backToMainBtn = document.getElementById('backToMainBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const searchInput = document.getElementById('searchInput');
        const historyList = document.getElementById('historyList');
        
        divineBtn.addEventListener('click', () => this.performDivination());
        newDivineBtn.addEventListener('click', () => this.resetForm());
        saveRecordBtn.addEventListener('click', () => this.saveCurrentRecord());
        historyBtn.addEventListener('click', () => {
            console.log('=== 历史记录按钮被点击 ===');
            console.log('historyBtn元素:', historyBtn);
            this.showHistory();
        });
        backToMainBtn.addEventListener('click', () => this.backToMain());
        clearHistoryBtn.addEventListener('click', () => this.clearHistory());
        
        // 搜索功能
        searchInput.addEventListener('input', (e) => this.searchHistory(e.target.value));
        
        // 回车键触发占卜
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !document.getElementById('resultSection').style.display) {
                this.performDivination();
            }
        });

        // 历史记录删除按钮事件委托
        if (historyList) {
            historyList.addEventListener('click', (e) => {
                const btn = e.target.closest('.delete-record-btn');
                if (btn) {
                    const recordEl = btn.closest('.history-record');
                    const id = recordEl?.dataset.id || btn.dataset.id;
                    if (id) {
                        this.deleteRecord(id);
                    }
                }
            });
        }
    }
    
    // 设置默认时间（当前时间对应的农历时辰）
    setDefaultTime() {
        const now = new Date();
        const hour = now.getHours();
        
        // 根据当前时间设置默认时辰
        let defaultHour = '';
        if (hour >= 23 || hour < 1) defaultHour = '子';
        else if (hour >= 1 && hour < 3) defaultHour = '丑';
        else if (hour >= 3 && hour < 5) defaultHour = '寅';
        else if (hour >= 5 && hour < 7) defaultHour = '卯';
        else if (hour >= 7 && hour < 9) defaultHour = '辰';
        else if (hour >= 9 && hour < 11) defaultHour = '巳';
        else if (hour >= 11 && hour < 13) defaultHour = '午';
        else if (hour >= 13 && hour < 15) defaultHour = '未';
        else if (hour >= 15 && hour < 17) defaultHour = '申';
        else if (hour >= 17 && hour < 19) defaultHour = '酉';
        else if (hour >= 19 && hour < 21) defaultHour = '戌';
        else if (hour >= 21 && hour < 23) defaultHour = '亥';
        
        document.getElementById('hour').value = defaultHour;
    }
    
    // 执行占卜
    performDivination() {
        const question = document.getElementById('question').value.trim();
        const month = parseInt(document.getElementById('month').value);
        const day = parseInt(document.getElementById('day').value);
        const hour = document.getElementById('hour').value;
        
        // 验证输入
        const validation = this.validateInput(month, day, hour);
        if (!validation.valid) {
            this.showError(validation.message);
            return;
        }
        
        // 清除之前的错误信息
        this.clearMessages();
        
        // 显示加载状态
        this.showLoading(true);
        
        // 模拟占卜过程（添加一点延迟增加仪式感）
        setTimeout(() => {
            const result = this.calculate(month, day, hour, question);
            this.displayResult(result);
            this.showLoading(false);
        }, 800);
    }
    
    // 保存当前占卜记录
    saveCurrentRecord() {
        console.log('=== 开始保存记录 ===');
        console.log('当前结果:', this.currentResult);
        
        if (!this.currentResult) {
            console.log('错误: 没有可保存的占卜结果');
            this.showError('没有可保存的占卜结果');
            return;
        }
        
        try {
            const record = this.history.saveRecord(this.currentResult);
            console.log('保存的记录:', record);
            
            // 验证是否真的保存到localStorage
            const allRecords = this.history.getRecords();
            console.log('localStorage中的所有记录:', allRecords);
            console.log('记录总数:', allRecords.length);
            
            this.showSuccess('占卜记录已保存');
            
            // 可选：保存后禁用保存按钮，避免重复保存
            const saveBtn = document.getElementById('saveRecordBtn');
            saveBtn.textContent = '已保存';
            saveBtn.disabled = true;
            saveBtn.style.opacity = '0.6';
        } catch (error) {
            console.error('保存记录失败:', error);
            this.showError('保存记录失败，请重试');
        }
    }
    
    // 显示历史记录
    showHistory() {
        console.log('=== 显示历史记录 ===');
        
        const historySection = document.getElementById('historySection');
        const mainContent = document.querySelector('.main-content');
        const calendarSection = document.querySelector('.calendar-section');
        const formSection = document.querySelector('.divination-form');
        const resultSection = document.getElementById('resultSection');
        
        console.log('historySection元素:', historySection);
        console.log('mainContent元素:', mainContent);
        console.log('calendarSection元素:', calendarSection);
        console.log('formSection元素:', formSection);
        console.log('resultSection元素:', resultSection);

        // 保持父容器可见，只切换区块显隐
        mainContent.style.display = 'block';
        if (calendarSection) calendarSection.style.display = 'none';
        if (formSection) formSection.style.display = 'none';
        if (resultSection) resultSection.style.display = 'none';
        historySection.style.display = 'block';
        
        console.log('页面切换完成，开始加载历史记录');
        
        // 加载历史记录
        this.loadHistoryRecords();
    }
    
    // 返回主界面
    backToMain() {
        const historySection = document.getElementById('historySection');
        const mainContent = document.querySelector('.main-content');
        const calendarSection = document.querySelector('.calendar-section');
        const formSection = document.querySelector('.divination-form');
        const resultSection = document.getElementById('resultSection');
        
        // 显示主要内容各区块，隐藏历史记录
        historySection.style.display = 'none';
        if (calendarSection) calendarSection.style.display = 'block';
        if (formSection) formSection.style.display = 'block';
        if (resultSection) resultSection.style.display = 'none';
        mainContent.style.display = 'block';
        
        // 清空搜索框
        document.getElementById('searchInput').value = '';
    }
    
    // 加载历史记录
    loadHistoryRecords(records = null) {
        console.log('=== 加载历史记录 ===');
        
        const historyList = document.getElementById('historyList');
        console.log('historyList元素:', historyList);
        
        const recordsToShow = records || this.history.getRecords();
        console.log('要显示的记录:', recordsToShow);
        console.log('记录数量:', recordsToShow.length);
        
        if (recordsToShow.length === 0) {
            console.log('没有记录，显示空状态');
            historyList.innerHTML = '<div class="no-records">暂无历史记录</div>';
            return;
        }
        
        console.log('开始渲染记录列表');
        console.log('=== 强制刷新测试 v2 ===');
        
        // 先简单测试，直接设置一些HTML内容
        historyList.innerHTML = '<div style="color: red; font-size: 20px; padding: 20px;">测试内容 - 如果你看到这个，说明代码已更新</div>';
        console.log('设置测试内容完成');
        
        try {
            console.log('准备处理记录数据...');
            const htmlContent = recordsToShow.map((record, index) => {
                console.log(`处理第${index + 1}条记录:`, record);
                
                // 安全地获取记录属性，避免undefined错误
                const safeRecord = {
                    id: record.id || '',
                    date: record.date || '',
                    time: record.time || '',
                    question: record.question || '',
                    lunarDate: record.lunarDate || '',
                    liushen: record.liushen || '',
                    fortune: record.fortune || '',
                    meaning: record.meaning || ''
                };
                
                console.log(`安全记录数据:`, safeRecord);
                
                return `
                <div class="history-record" data-id="${safeRecord.id}">
                    <div class="record-header">
                        <div class="record-date">${safeRecord.date} ${safeRecord.time}</div>
                        <button type="button" class="delete-record-btn" data-id="${safeRecord.id}">删除</button>
                    </div>
                    <div class="record-content">
                        <div class="record-question">
                            <strong>问题：</strong>${safeRecord.question}
                        </div>
                        <div class="record-lunar-date">
                            <strong>时间：</strong>${safeRecord.lunarDate}
                        </div>
                        <div class="record-result">
                            <strong>结果：</strong>${safeRecord.liushen} 
                            <span class="fortune-${safeRecord.fortune === '吉' ? 'good' : 'bad'}">(${safeRecord.fortune})</span>
                        </div>
                        <div class="record-meaning">
                            <strong>解释：</strong>${safeRecord.meaning}
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            console.log('HTML内容生成成功，长度:', htmlContent.length);
            console.log('生成的HTML内容:', htmlContent);
            
            historyList.innerHTML = htmlContent;
            console.log('HTML设置完成，historyList.innerHTML:', historyList.innerHTML);
            console.log('historyList子元素数量:', historyList.children.length);
            
        } catch (error) {
            console.error('渲染记录列表时出错:', error);
            console.error('错误堆栈:', error.stack);
            historyList.innerHTML = '<div class="no-records">渲染历史记录时出现错误</div>';
        }
    }
    
    // 搜索历史记录
    searchHistory(keyword) {
        const filteredRecords = this.history.searchRecords(keyword);
        this.loadHistoryRecords(filteredRecords);
    }
    
    // 删除单条记录
    deleteRecord(id) {
        if (confirm('确定要删除这条记录吗？')) {
            this.history.deleteRecord(id);
            this.loadHistoryRecords();
            this.showSuccess('记录已删除');
        }
    }
    
    // 清空所有历史记录
    clearHistory() {
        if (confirm('确定要清空所有历史记录吗？此操作不可恢复。')) {
            this.history.clearAllRecords();
            this.loadHistoryRecords();
            this.showSuccess('所有记录已清空');
        }
    }
    
    // 显示成功消息
    showSuccess(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'success-message';
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            z-index: 1000;
            font-size: 14px;
        `;
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }
    
    // 验证输入
    validateInput(month, day, hour) {
        if (!month || month < 1 || month > 12) {
            return { valid: false, message: '请选择正确的农历月份（1-12月）' };
        }
        
        if (!day || day < 1 || day > 30) {
            return { valid: false, message: '请输入正确的农历日期（1-30日）' };
        }
        
        if (!hour || !this.dizhiOrder.includes(hour)) {
            return { valid: false, message: '请选择正确的时辰' };
        }
        
        return { valid: true };
    }
    
    // 计算六神占卜结果
    calculate(month, day, hour, question = '') {
        // 第一步：起月 - 从大安开始，按月份数数
        const monthPosition = (month - 1) % 6;
        const monthResult = this.liushenOrder[monthPosition];
        
        // 第二步：起日 - 从起月的结果开始，按日期数数
        const dayPosition = (monthPosition + day - 1) % 6;
        const dayResult = this.liushenOrder[dayPosition];
        
        // 第三步：起时 - 从起日的结果开始，按时辰数数
        const hourIndex = this.dizhiOrder.indexOf(hour);
        const hourCount = hourIndex + 1; // 子时为1，丑时为2，以此类推
        const finalPosition = (dayPosition + hourCount - 1) % 6;
        const finalResult = this.liushenOrder[finalPosition];
        
        // 构建计算步骤说明
        const steps = [
            `起月：从大安开始数${month}个月，得到"${monthResult}"`,
            `起日：从"${monthResult}"开始数${day}日，得到"${dayResult}"`,
            `起时：从"${dayResult}"开始数到${hour}时（第${hourCount}个时辰），得到"${finalResult}"`
        ];
        
        return {
            question,
            month,
            day,
            hour,
            liushen: finalResult,
            result: this.liushenResults[finalResult],
            steps
        };
    }
    
    // 显示占卜结果
    displayResult(result) {
        // 保存当前结果用于后续保存
        this.currentResult = result;
        
        const resultSection = document.getElementById('resultSection');
        const resultContent = document.getElementById('resultContent');
        
        const fortuneClass = result.result.fortune === '吉' ? 'fortune-good' : 'fortune-bad';
        
        resultContent.innerHTML = `
            ${result.question ? `
                <div class="result-item">
                    <h3>占卜问题</h3>
                    <p>${result.question}</p>
                </div>
            ` : ''}
            
            <div class="result-item">
                <h3>占卜时间</h3>
                <p>农历${result.month}月${result.day}日 ${result.hour}时</p>
            </div>
            
            <div class="calculation-steps">
                <h4>计算过程</h4>
                <ol>
                    ${result.steps.map(step => `<li>${step}</li>`).join('')}
                </ol>
            </div>
            
            <div class="result-item">
                <h3>占卜结果：${result.liushen} <span class="${fortuneClass}">(${result.result.fortune})</span></h3>
                <p><strong>传统断语：</strong></p>
                <p style="font-style: italic; color: #666; margin-bottom: 15px;">${result.result.text}</p>
                <p><strong>现代解释：</strong></p>
                <p>${result.result.meaning}</p>
            </div>
        `;
        
        // 隐藏表单，显示结果
        document.querySelector('.divination-form').style.display = 'none';
        resultSection.style.display = 'block';
        
        // 滚动到结果区域
        resultSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    // 重置表单
    resetForm() {
        // 重置保存按钮状态
        const saveBtn = document.getElementById('saveRecordBtn');
        if (saveBtn) {
            saveBtn.textContent = '保存记录';
            saveBtn.disabled = false;
            saveBtn.style.opacity = '1';
        }
        
        // 清空表单
        document.getElementById('question').value = '';
        document.getElementById('month').value = '';
        document.getElementById('day').value = '';
        
        // 重置当前结果
        this.currentResult = null;
        
        // 重新设置默认时间
        this.setDefaultTime();
        
        // 清除消息
        this.clearMessages();
        
        // 显示表单，隐藏结果
        document.querySelector('.divination-form').style.display = 'block';
        document.getElementById('resultSection').style.display = 'none';
        
        // 滚动到顶部
        document.querySelector('.header').scrollIntoView({ behavior: 'smooth' });
    }
    
    // 显示错误信息
    showError(message) {
        this.clearMessages();
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        
        const form = document.querySelector('.divination-form');
        form.insertBefore(errorDiv, form.firstChild);
        
        // 3秒后自动清除错误信息
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 3000);
    }
    
    // 清除所有消息
    clearMessages() {
        const messages = document.querySelectorAll('.error-message, .success-message');
        messages.forEach(msg => {
            if (msg.parentNode) {
                msg.parentNode.removeChild(msg);
            }
        });
    }
    
    // 显示/隐藏加载状态
    showLoading(show) {
        const form = document.querySelector('.divination-form');
        const btn = document.getElementById('divineBtn');
        
        if (show) {
            form.classList.add('loading');
            btn.textContent = '占卜中...';
            btn.disabled = true;
        } else {
            form.classList.remove('loading');
            btn.textContent = '开始占卜';
            btn.disabled = false;
        }
    }
}

// 页面加载完成后初始化应用
document.addEventListener('DOMContentLoaded', () => {
    new Calendar();
    const app = new LiushenDivination();
    window.app = app;
});

// 注册 Service Worker（PWA支持）
if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
        const isLocalhost = ['localhost', '127.0.0.1'].includes(location.hostname);
        if (isLocalhost) {
            try {
                const regs = await navigator.serviceWorker.getRegistrations();
                for (const reg of regs) {
                    await reg.unregister();
                }
                console.log('SW unregistered on localhost');
                if (window.caches) {
                    const keys = await caches.keys();
                    await Promise.all(keys.map(k => caches.delete(k)));
                    console.log('Cache Storage cleared');
                }
            } catch (e) {
                console.log('Failed to unregister SW/clear caches:', e);
            }
            return; // 本地开发不注册SW，避免缓存问题
        }

        navigator.serviceWorker.register('./sw.js?v=20241028002')
            .then(registration => {
                console.log('SW registered: ', registration);
                try { registration.update(); } catch (e) { /* ignore */ }
                if (registration.installing) {
                    registration.installing.addEventListener('statechange', () => {
                        console.log('SW installing state:', registration.installing?.state);
                    });
                }
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    console.log('SW update found:', newWorker);
                    newWorker && newWorker.addEventListener('statechange', () => {
                        console.log('SW new worker state:', newWorker.state);
                    });
                });
            })
            .catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}